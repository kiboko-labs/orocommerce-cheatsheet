<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Kiboko">
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Extending an entity (Business Unit example) - orocommerce-cheatsheet</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Extending an entity (Business Unit example)";
    var mkdocs_page_input_path = "migrations/businessUnit.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> orocommerce-cheatsheet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Useful commands</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../command/oro1/">Oro 1.x</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../command/oro3/">Oro 3.x</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Backend tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/remove-price-filter/">Remove Price filter and sorter</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Comment créer un EventListener pour modifier une DataGrid</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../backend/event-listener-datagrid-orm-result/">Orm Result</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../backend/event-listener-datagrid-structure/">Structure</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/dynamic-action-datagrid/">Gérer dynamiquement des actions dans une datagrid</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/pass-param-to-datagrid/">Faire passer un paramètre à une datagrid</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/delete-entity/">Comment supprimer proprement une entité</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/handler-provider-update/">Faire des handlers / providers (update entity)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/oro-config-select-type/">Champ select en config</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Frontend tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/BlockTypes/">BlockTypes examples</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/ElementList/">List of Ui element present in OroUIBundle::macros.html.twig</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/findblockname/">Find Twig Template block names</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/mass-actions/">Ajouter une Mass-Action sur la grille des produits</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/form/">Create a frontend form for an entity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/consent-rgpd/">RGPD</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/products-list/">Product List</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Environment tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/installer-xdebug-php71/">Installer Xdebug pour php 7.1 sur MacOS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/installer-rabbitmq-brew/">Installer RabbitMQ avec Brew sur MacOS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/avoir-xdebug-a-la-demande/">Activer XDebug à la demande</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/supervisor/">Utilisation de Supervisor</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/composer-tips/">Utilisation de composer</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../postgresql/insert-medias/">Insert product medias in the database</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../postgresql/sql-tips/">Pour identifier les tables lourdes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Migration tips</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../introduction/">Introduction schema manipulation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../enum/">Managing enums</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Extending an entity (Business Unit example)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#extending-the-businessunit-entity">Extending the BusinessUnit entity</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#extending-the-businessunittype">Extending the BusinessUnitType</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#creating-the-form-listener">Creating the form listener</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../view/">Managing the fields order on the form view</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../configuration/">Configuring the platform via migrations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../delete-completely-an-enum/">Delete completely an enum</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Docker tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/dump-sql-docker/">Maninipuler des dumps.sql avec Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/use-cache/">Utiliser le cache Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/clean-vm/">Nettoyer sa VM</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Test tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tests/intro/">Intro</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tests/behat/">Behat</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tests/javascript/">Javascript</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tests/functional/">Functionnal</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">orocommerce-cheatsheet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Migration tips &raquo;</li>
        
      
    
    <li>Extending an entity (Business Unit example)</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/kiboko-labs/orocommerce-cheatsheet/edit/master/docs/migrations/businessUnit.md"
          class="icon icon-github"> Edit on Github</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="business-unit-migration">Business Unit migration</h1>
<h2 id="extending-the-businessunit-entity">Extending the BusinessUnit entity</h2>
<p>Extending the BusinessUnit entity is rather easy. Just create a new class in the <code>[Bundle]\Migrations\Schema\vx_x</code> namespace and make it implement the <code>Oro\Bundle\MigrationBundle\Migration\Migration</code> interface (and eventually the <code>Oro\Bundle\AttachmentBundle\Migration\Extension\AttachmentExtensionAwareInterface</code> if you need to have attachments to your entity, like images or any files).</p>
<p>Below is an example from <code>kiboko-labs/sevea-orocommerce</code>:</p>
<pre><code class="php">&lt;?php


namespace Kiboko\Bundle\AppBundle\Migrations\Schema\v1_0;


use Doctrine\DBAL\Schema\Schema;
use Oro\Bundle\AttachmentBundle\Migration\Extension\AttachmentExtension;
use Oro\Bundle\AttachmentBundle\Migration\Extension\AttachmentExtensionAwareInterface;
use Oro\Bundle\EntityExtendBundle\EntityConfig\ExtendScope;
use Oro\Bundle\EntityExtendBundle\Migration\OroOptions;
use Oro\Bundle\MigrationBundle\Migration\Migration;
use Oro\Bundle\MigrationBundle\Migration\QueryBag;

class CustomizeBusinessUnit implements Migration, AttachmentExtensionAwareInterface
{
    const TABLE_NAME = 'oro_business_unit';
    const THUMB_WIDTH = 200;
    const THUMB_HEIGHT = 200;
    const IMAGE_SIZE = 2;

    /** @var AttachmentExtension */
    protected $attachmentExtension;

    /**
     * Sets the AttachmentExtension
     *
     * @param AttachmentExtension $attachmentExtension
     */
    public function setAttachmentExtension(AttachmentExtension $attachmentExtension)
    {
        $this-&gt;attachmentExtension = $attachmentExtension;
    }

    /**
     * Modifies the given schema to apply necessary changes of a database
     * The given query bag can be used to apply additional SQL queries before and after schema changes
     *
     * @param Schema $schema
     * @param QueryBag $queries
     * @return void
     * @throws \Doctrine\DBAL\Schema\SchemaException
     */
    public function up(Schema $schema, QueryBag $queries)
    {
        $table = $schema-&gt;getTable(self::TABLE_NAME);
        $table-&gt;addColumn('address', 'string', [
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM, 'entity' =&gt; ['description' =&gt; 'The address of the business unit']],
                'view' =&gt; ['priority' =&gt; 200],
            ],
        ]);
        $table-&gt;addColumn('address_details', 'string', [
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 190],
            ],
        ]);
        $table-&gt;addColumn('postal_code', 'string', [
            'length' =&gt; 5,
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 180],
            ],
        ]);
        $table-&gt;addColumn('town', 'string', [
            'length' =&gt; 100,
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 170],
            ],
        ]);
        $table-&gt;addColumn('longitude', 'float', [
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 160],
            ],
        ]);
        $table-&gt;addColumn('latitude', 'float', [
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 150],
            ],
        ]);
        $table-&gt;addColumn('type', 'string', [
            'length' =&gt; 10,
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 140],
            ],
        ]);
        $table-&gt;addColumn('erp_code', 'string', [
            'length' =&gt; 20,
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 120],
            ],
        ]);
        $table-&gt;addColumn('facebook', 'string', [
            OroOptions::KEY =&gt; [
                'extend' =&gt; ['owner' =&gt; ExtendScope::OWNER_CUSTOM],
                'view' =&gt; ['priority' =&gt; 110],
            ],
        ]);
        $this-&gt;attachmentExtension-&gt;addImageRelation(
            $schema,
            self::TABLE_NAME,
            'image',
            [],
            self::IMAGE_SIZE,
            self::THUMB_WIDTH,
            self::THUMB_HEIGHT
        );
    }
}
</code></pre>

<blockquote>
<p>Be very careful ! If you mistake, it's possible you'll have to run the <code>oro:install</code> command again. Oro keeps memory of the previous structure in database (table <code>oro_entity_config_field</code>), stored base64 serialized BLOB field. Really difficult to update.</p>
</blockquote>
<h2 id="extending-the-businessunittype">Extending the BusinessUnitType</h2>
<p>You have to write a new type extension in order to add and configure the fields of the form. You may create new fields, and override "parent" field configurations.</p>
<pre><code class="php">&lt;?php


namespace Kiboko\Bundle\AppBundle\Form\Extension;


use Oro\Bundle\AttachmentBundle\Form\Type\ImageType;
use Oro\Bundle\OrganizationBundle\Form\Type\BusinessUnitType;
use Symfony\Component\Form\AbstractTypeExtension;
use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
use Symfony\Component\Form\FormBuilderInterface;

class BusinessUnitExtension extends AbstractTypeExtension
{
    const TYPE_VENDOR = 'vendor';
    const TYPE_VITRINE = 'vitrine';
    const TYPE_EXTERNAL = 'external';

    /**
     * Returns the name of the type being extended.
     *
     * @return string The name of the type being extended
     */
    public function getExtendedType()
    {
        return BusinessUnitType::class;
    }

    /**
     * @param FormBuilderInterface $builder
     * @param array $options
     */
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            -&gt;add('image', ImageType::class)
            -&gt;add('type', ChoiceType::class, [
                'label' =&gt; $this-&gt;getTranslationKey('type'),
                'choices' =&gt; [
                    $this-&gt;getTranslationKey('type.choices.vendor') =&gt; self::TYPE_VENDOR,
                    $this-&gt;getTranslationKey('type.choices.vitrine') =&gt; self::TYPE_VITRINE,
                    $this-&gt;getTranslationKey('type.choices.external') =&gt; self::TYPE_EXTERNAL,
                ]
            ])
        ;
    }

    private function getTranslationKey(string $key) : string
    {
        return sprintf('oro.organization.businessunit.%s.label', $key);
    }
}
</code></pre>

<h2 id="creating-the-form-listener">Creating the form listener</h2>
<p>New fields declared in the type extension above won't be added automatically on the form view.
In order to add those fields on the form view, we need to hook into the form prerender event <code>Oro\Bundle\UIBundle\Event\Events::BEFORE_UPDATE_FORM_RENDER</code>.</p>
<pre><code class="php">&lt;?php


namespace Kiboko\Bundle\AppBundle\EventListener;


use Oro\Bundle\UIBundle\Event\BeforeFormRenderEvent;
use Oro\Bundle\UIBundle\Event\Events;
use Oro\Bundle\UIBundle\View\ScrollData;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\Form\FormView;

class BusinessUnitFormListener implements EventSubscriberInterface
{
    const FORM_NAME = 'oro_business_unit_form';

    /**
     * @return array The event names to listen to
     */
    public static function getSubscribedEvents()
    {
        return [
            Events::BEFORE_UPDATE_FORM_RENDER =&gt; 'onBusinessUnitEdit',
        ];
    }

    public function onBusinessUnitEdit(BeforeFormRenderEvent $event)
    {
        $form = $event-&gt;getForm();
        if (!$this-&gt;supports($form)) {
            return;
        }

        $template = $event-&gt;getTwigEnvironment()-&gt;render(
            '@KibokoApp/Form/file_widget.html.twig',
            ['form' =&gt; $form-&gt;children['image']]
        );

        $scrollData = new ScrollData($event-&gt;getFormData());
        $scrollData-&gt;addSubBlockData(1, 0, $template, 'image');

        $event-&gt;setFormData($scrollData-&gt;getData());
    }

    /**
     * @param FormView $formView
     * @return bool
     */
    protected function supports(FormView $formView)
    {
        return $formView-&gt;vars['name'] === self::FORM_NAME;
    }
}
</code></pre>

<blockquote>
<p>Be careful, as each form rendering will trigger this event. Be sure to filter the forms with a <code>supports</code> method as above, for example</p>
</blockquote>
<p>The form data can be found via the <code>BeforeFormRenderEvent</code>. It's just a flat array, that is easier to manipulate wrapped into a <code>Oro\Bundle\UIBundle\View\ScrollData</code> object.</p>
<p>The goal is to generate the HTML for each added form field:</p>
<pre><code class="php">$template = $event-&gt;getTwigEnvironment()-&gt;render(
    '@KibokoApp/Form/file_widget.html.twig',
    ['form' =&gt; $form-&gt;children['image']]
);
</code></pre>

<p>and to place it at the required place in the form data:</p>
<pre><code class="php">$scrollData-&gt;addSubBlockData(1, 0, $template, 'image');
</code></pre>

<p>You'll have to create the template file yourself. In the above example (<code>file_widget.html.twig</code>), it's just a one-line template:</p>
<pre><code class="twig">{{ form_row(form) }}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../view/" class="btn btn-neutral float-right" title="Managing the fields order on the form view">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../enum/" class="btn btn-neutral" title="Managing enums"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../enum/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../view/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
