<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Kiboko">
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Functionnal - orocommerce-cheatsheet</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Functionnal";
    var mkdocs_page_input_path = "tests/functional.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> orocommerce-cheatsheet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Useful commands</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../command/oro1/">Oro 1.x</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../command/oro3/">Oro 3.x</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Backend tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/remove-price-filter/">Remove Price filter and sorter</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Comment créer un EventListener pour modifier une DataGrid</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../backend/event-listener-datagrid-orm-result/">Orm Result</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../backend/event-listener-datagrid-structure/">Structure</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/dynamic-action-datagrid/">Gérer dynamiquement des actions dans une datagrid</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/pass-param-to-datagrid/">Faire passer un paramètre à une datagrid</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/delete-entity/">Comment supprimer proprement une entité</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/handler-provider-update/">Faire des handlers / providers (update entity)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../backend/oro-config-select-type/">Champ select en config</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Frontend tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/BlockTypes/">BlockTypes examples</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/ElementList/">List of Ui element present in OroUIBundle::macros.html.twig</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/findblockname/">Find Twig Template block names</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/mass-actions/">Ajouter une Mass-Action sur la grille des produits</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/form/">Create a frontend form for an entity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/consent-rgpd/">RGPD</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../frontend/products-list/">Product List</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Environment tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/installer-xdebug-php71/">Installer Xdebug pour php 7.1 sur MacOS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/installer-rabbitmq-brew/">Installer RabbitMQ avec Brew sur MacOS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/avoir-xdebug-a-la-demande/">Activer XDebug à la demande</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/supervisor/">Utilisation de Supervisor</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../environment/composer-tips/">Utilisation de composer</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../postgresql/insert-medias/">Insert product medias in the database</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../postgresql/sql-tips/">Pour identifier les tables lourdes</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Migration tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/introduction/">Introduction schema manipulation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/enum/">Managing enums</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/businessUnit/">Extending an entity (Business Unit example)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/view/">Managing the fields order on the form view</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/configuration/">Configuring the platform via migrations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/delete-completely-an-enum/">Delete completely an enum</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Docker tips</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/dump-sql-docker/">Maninipuler des dumps.sql avec Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/use-cache/">Utiliser le cache Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../docker/clean-vm/">Nettoyer sa VM</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Test tips</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../intro/">Intro</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../behat/">Behat</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../javascript/">Javascript</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Functionnal</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#quand-rediger-les-tests-fonctionnels">Quand rédiger les tests fonctionnels</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#environnement-de-test">Environnement de test</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initialisation-du-client-et-avertissement-quand-aux-chargement-des-fixtures">Initialisation du client et avertissement quand aux chargement des fixtures</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configuration-dun-environnement-de-test">Configuration d'un environnement de test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#database-isolation">Database Isolation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#chargement-des-data-fixtures">Chargement des data fixtures :</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#notes">NOTES :</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ecrire-des-test-fonctionnel">Ecrire des test fonctionnel :</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#tests-fonctionnel-pour-les-controlleurs">Tests fonctionnel pour les controlleurs :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exemples-de-prepraration-du-client">Exemples de prépraration du client :</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#types-de-tests-fonctionnels">Types de tests fonctionnels</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#tester-les-controllers">Tester les controllers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tester-les-acls-dans-les-controlleurs">Tester les ACLs dans les controlleurs :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tester-les-commandes">Tester les commandes :</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#voir-aussi">VOIR AUSSI</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tester-les-services-ou-les-repositories">Tester les services ou les Repositories</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#example-de-test-fonctionnel">Example de test fonctionnel :</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#attention">Attention</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">orocommerce-cheatsheet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Test tips &raquo;</li>
        
      
    
    <li>Functionnal</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/kiboko-labs/orocommerce-cheatsheet/edit/master/docs/tests/functional.md"
          class="icon icon-github"> Edit on Github</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="tests-fonctionnels">Tests fonctionnels</h1>
<p>Les tests fonctionnels permettent de vérifier l’intégration des différentes couches d’une application.</p>
<p>Dans cet article, vous apprendrez comment vous pouvez améliorer l’expérience de la rédaction de tests fonctionnels avec
Oroplatform. Il est recommandé de lire la <a href="https://symfony.com/doc/4.4/testing.html#functional-tests">Doc Symfony</a>
concernant les tests avant de continuer. Vous devriez également connaître <a href="https://phpunit.de/getting-started/phpunit-9.html">PhpUnit</a></p>
<h2 id="quand-rediger-les-tests-fonctionnels">Quand rédiger les tests fonctionnels</h2>
<p>Les tests fonctionnels sont généralement rédigés pour les :</p>
<p>Contrôleurs
Commandes
Dépôts
Autres services</p>
<p>L’objectif des tests fonctionnels n’est pas de tester des classes séparées (tests unitaires), mais de tester
l’intégration des différentes parties d’une application.</p>
<p>Ajouter des tests fonctionnels pour compléter les tests unitaires pour les raisons suivantes :</p>
<ul>
<li>Vous pouvez tester le système multi-composants et vous assurer qu’il fonctionne comme un tout.</li>
<li>Vous pouvez éviter la simulation(mocking) de l’interface compliquée ou de la couche de manipulation de données
(comme les classes de doctrine pour construire une requête).
Les tests unitaires peuvent réussir même si les fonctionnalités ne fonctionnent pas correctement.</li>
</ul>
<h2 id="environnement-de-test">Environnement de test</h2>
<h3 id="initialisation-du-client-et-avertissement-quand-aux-chargement-des-fixtures">Initialisation du client et avertissement quand aux chargement des fixtures</h3>
<p>Pour améliorer la performance de l’exécution du test, l’initialisation d’un client n’est effectuée qu’une seule fois par
cas de test par défaut. Cela signifie que le noyau de l’application Symfony sera démarré une fois par cas de test.
Les fixtures sont également chargés une seule fois par cas de test par défaut. D’une part, initialiser et charger
des fixtures une fois par cas de test augmente la performance de l’exécution de test mais peut aussi causer des bugs
car  l’état des fixtures et du noyau (et par conséquent, le conteneur de service) sera partagé par défaut entre les
méthodes de test de cas de test séparés. Assurez-vous de réinitialiser cet état si nécessaire.</p>
<h3 id="configuration-dun-environnement-de-test">Configuration d'un environnement de test</h3>
<p>Vous devez configurer les paramètres suivants pour l’environnement de test :</p>
<ol>
<li>
<p>Créer une base de données distincte pour les tests (p. ex., ajouter le suffixe « _test ») :</p>
</li>
<li>
<p>Configurez les paramètres hôte, port et authentification pour la base de données, le serveur de messagerie et le
 serveur de socket web dans le fichier parameters_test.yml :</p>
</li>
</ol>
<p>Par exemple :</p>
<pre><code class="yaml"># config/parameters_test.yml
parameters:
    database_host: 127.0.0.1
    database_port: null
    database_name: crm_test
    database_user: root
    database_password: null
    mailer_transport: smtp
    mailer_host: 127.0.0.1
    mailer_port: null
    mailer_encryption: null
    mailer_user: null
    mailer_password: null
    session_handler: null
    locale: en
    secret: ThisTokenIsNotSoSecretChangeIt
    installed: false
</code></pre>

<ol>
<li>Installez l'application dans un environnement de test</li>
</ol>
<pre><code>bin/console oro:install \
 --env=test  \
 --organization-name=Oro \
 --user-name=admin \
 --user-email=admin@example.com \
 --user-firstname=John \
 --user-lastname=Doe \
 --user-password=admin \
 --sample-data=n \
 --application-url=http://localhost
</code></pre>

<p>Lors de l’installation, la structure de la base de données est configurée et les fixtures standard sont chargés.</p>
<ol>
<li>Exécuter les tests en utilisant phpunit avec l’option –testsuite appropriée (unit ou functionnal).</li>
</ol>
<p>ATTENTION
Actuellement, l’exécution de différents types de tests automatisés ensemble n’est pas prise en charge.
Il est donc fortement déconseillé d’exécuter des tests unitaires et des tests fonctionnels côte à côte en une seule exécution, car cela produit des erreurs.
Les tests unitaires créent des objets fictifs qui interfèrent ultérieurement avec l’exécution des tests fonctionnels 
et créent une ambiguïté inutile. Il est possible de désactiver les tests unitaires au démarrage du test à l’aide de l’option testsuite :</p>
<p>$ php bin/phpunit -c . / --testsuite=functional
$ php bin/phpunit -c . / --testsuite=unit</p>
<h2 id="database-isolation">Database Isolation</h2>
<p>L'annotation @dbIsolationPerTest ajoute une transaction qui sera effectuée avant le début d’un test et qui est annulée lorsqu’un test se termine.</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

/**
 * @dbIsolationPerTest
 */
class FooBarTest extends WebTestCase
{
    // ...
}
</code></pre>

<h2 id="chargement-des-data-fixtures">Chargement des data fixtures :</h2>
<p>Utilisez la méthode loadFixtures() pour charger des données dans un test :</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected function setUp()
    {
        $this-&gt;initClient(); // must be called before!

        // loading fixtures will be executed once, use the second parameter
        // $force = true to force the loading
        $this-&gt;loadFixtures([
            'Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures\LoadFooData',
            '@OroFooBarBundle/Tests/Functional/DataFixtures/bar_data.yml',
        ]);
    }

    // ...
}
</code></pre>

<p>Un fixture doit être soit un nom de classe qui implémente Doctrine\Common\DataFixtures\FixtureInterface , soit un chemin vers le fichier nelmio/alice.</p>
<p>Un exemple de fixture :</p>
<pre><code class="php">// src/Oro/Bundle/FooBarBundle/Tests/Functional/DataFixtures/LoadFooData.php
namespace Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures;

use Doctrine\Common\DataFixtures\AbstractFixture;
use Doctrine\Common\Persistence\ObjectManager;
use Oro\Bundle\FooBarBundle\Entity\FooEntity;

class LoadFooData extends AbstractFixture
{
    public function load(ObjectManager $manager)
    {
        $entity = new FooEntity();
        $manager-&gt;persist($entity);
        $manager-&gt;flush();
    }
}
</code></pre>

<pre><code class="yaml">    # src/Oro/Bundle/FooBarBundle/Tests/Functional/DataFixtures/bar_data.yml
    Oro\Bundle\FooBarBundle\Entity\BarEntity:
        bar:
            name: test
</code></pre>

<p>Vous pouvez également implémenter l’interfaceDoctrine\Common\DataFixtures\DependentFixtureInterface qui permet de charger des fixtures en fonction des autres fixtures déjà chargées :</p>
<pre><code class="php">// src/Oro/Bundle/FooBarBundle/Tests/Functional/DataFixtures/LoadFooData.php
namespace Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures;

use Doctrine\Common\DataFixtures\DependentFixtureInterface;
use Doctrine\Common\DataFixtures\AbstractFixture;
use Doctrine\Common\Persistence\ObjectManager;

class LoadFooData extends AbstractFixture implements DependentFixtureInterface
{
    public function load(ObjectManager $manager)
    {
        // load fixtures
    }

    public function getDependencies()
    {
        return ['Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures\LoadBarData'];
    }
}
</code></pre>

<p>De plus, vous pouvez utiliser des entités spécifiques aux références à partir de fixtures, par exemple :</p>
<pre><code class="php">namespace Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures;

use Doctrine\Common\Persistence\ObjectManager;
use Doctrine\Common\DataFixtures\DependentFixtureInterface;
use Doctrine\Common\DataFixtures\AbstractFixture;

use Oro\Bundle\FooBarBundle\Entity\FooEntity;

class LoadFooData extends AbstractFixture implements DependentFixtureInterface
{
    public function load(ObjectManager $manager)
    {
        $entity = new FooEntity();
        $manager-&gt;persist($entity);
        $manager-&gt;flush();

        $this-&gt;addReference('my_entity', $entity);
    }

    public function getDependencies()
    {
        return ['Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures\LoadBarData'];
    }
}
</code></pre>

<p>Maintenant, vous pouvez référencer le fixture par le nom configuré dans votre test :</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected $entity;

    protected function setUp()
    {
        $this-&gt;initClient();
        $this-&gt;loadFixtures('Oro\Bundle\FooBarBundle\Tests\Functional\DataFixtures\LoadFooData');
        $this-&gt;entity = $this-&gt;getReference('my_entity');
    }

    // ...
}
</code></pre>

<h3 id="notes">NOTES :</h3>
<ol>
<li>Par défaut, le gestionnaire d’entités est effacé après le chargement de chaque fixture. Pour éviter le nettoyage une fixture peut implémenterOro\Bundle\TestFrameworkBundle\Test\DataFixtures\InitialFixtureInterface.</li>
<li>Parfois, vous avez besoin d’une référence à l’Organization, d'un User ou d'une BusinessUnit. Les fixtures suivants peuvent être utilisés pour les charger :</li>
<li>Oro\Bundle\TestFrameworkBundle\Tests\Functional\DataFixtures\LoadOrganization</li>
<li>Oro\Bundle\TestFrameworkBundle\Tests\Functional\DataFixtures\LoadUser</li>
<li>Oro\Bundle\TestFrameworkBundle\Tests\Functional\DataFixtures\LoadBusinessUnit</li>
</ol>
<h2 id="ecrire-des-test-fonctionnel">Ecrire des test fonctionnel :</h2>
<p>Pour créer un test fonctionel :</p>
<ol>
<li>Etendez la classe WebTestCase</li>
<li>Préparez une instance de la classe Client</li>
<li>Préparez vos fixtures ( Optionnel)</li>
<li>Préparez le container</li>
<li>Appelez les fonctionnalitées du test
6 Vérifiez le résultat</li>
</ol>
<h3 id="tests-fonctionnel-pour-les-controlleurs">Tests fonctionnel pour les controlleurs :</h3>
<p>Un test fonctionnel pour un contrôleur se compose de quelques étapes:</p>
<ol>
<li>Faire une requete</li>
<li>Tester la réponse</li>
<li>Cliquez sur un lien ou soumettez un formulaire</li>
<li>Test the response</li>
<li>Nettoyer et répéter</li>
</ol>
<h3 id="exemples-de-prepraration-du-client">Exemples de prépraration du client :</h3>
<p>L’initialisation simple fonctionne pour tester les commandes et les services lorsque l’authentification n’est pas nécessaire.</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected function setUp()
    {
        $this-&gt;initClient(); // initialization occurres only once per test class
        // now varialbe $this-&gt;client is available
    }
    // ...
}
</code></pre>

<p>Initialisation avec les options Appkernel personnalisées :</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected function setUp()
    {
        // first array is Kernel options
        $this-&gt;initClient(['debug' =&gt; false]);
    }
    // ...
}
</code></pre>

<p>Initialisation avec authentification :</p>
<pre><code class="php">// src/Oro/Bundle/FooBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected function setUp()
    {
        // second array is service options
        // this example will create client with server options ['PHP_AUTH_USER' =&gt; 'admin@example.com', 'PHP_AUTH_PW' =&gt; 'admin']
        // make sure you loaded fixture with test user
        // bin/console doctrine:fixture:load --no-debug --append --no-interaction --env=test --fixtures src/Oro/src/Oro/Bundle/TestFrameworkBundle/Fixtures
        $this-&gt;initClient([], $this-&gt;generateBasicAuthHeader());

        // init client with custom username and password
        $this-&gt;initClient([], $this-&gt;generateBasicAuthHeader('custom_username', 'custom_password'));
    }
    // ...
}
</code></pre>

<h2 id="types-de-tests-fonctionnels">Types de tests fonctionnels</h2>
<h3 id="tester-les-controllers">Tester les controllers</h3>
<pre><code class="php">// src/OroCRM/Bundle/TaskBundle/Tests/Functional/Controller/TaskControllersTest.php
namespace Oro\Bundle\TaskBundle\Tests\Functional\Controller;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

/**
 * @outputBuffering enabled
 */
class TaskControllersTest extends WebTestCase
{
    protected function setUp()
    {
        $this-&gt;initClient([], $this-&gt;generateBasicAuthHeader());
    }

    public function testCreate()
    {
        $crawler = $this-&gt;client-&gt;request('GET', $this-&gt;getUrl('orocrm_task_create'));

        $form = $crawler-&gt;selectButton('Save and Close')-&gt;form();
        $form['orocrm_task[subject]'] = 'New task';
        $form['orocrm_task[description]'] = 'New description';
        $form['orocrm_task[dueDate]'] = '2014-03-04T20:00:00+0000';
        $form['orocrm_task[owner]'] = '1';
        $form['orocrm_task[reporter]'] = '1';

        $this-&gt;client-&gt;followRedirects(true);
        $crawler = $this-&gt;client-&gt;submit($form);
        $result = $this-&gt;client-&gt;getResponse();
        $this-&gt;assertHtmlResponseStatusCodeEquals($result, 200);
        $this-&gt;assertContains('Task saved', $crawler-&gt;html());
    }

    /**
     * @depends testCreate
     */
    public function testUpdate()
    {
        $response = $this-&gt;client-&gt;requestGrid(
            'tasks-grid',
            ['tasks-grid[_filter][reporterName][value]' =&gt; 'John Doe']
        );

        $result = $this-&gt;getJsonResponseContent($response, 200);
        $result = reset($result['data']);

        $crawler = $this-&gt;client-&gt;request(
            'GET',
            $this-&gt;getUrl('orocrm_task_update', ['id' =&gt; $result['id']])
        );

        $form = $crawler-&gt;selectButton('Save and Close')-&gt;form();
        $form['orocrm_task[subject]'] = 'Task updated';
        $form['orocrm_task[description]'] = 'Description updated';

        $this-&gt;client-&gt;followRedirects(true);
        $crawler = $this-&gt;client-&gt;submit($form);
        $result = $this-&gt;client-&gt;getResponse();

        $this-&gt;assertHtmlResponseStatusCodeEquals($result, 200);
        $this-&gt;assertContains('Task saved', $crawler-&gt;html());
    }

    /**
     * @depends testUpdate
     */
    public function testView()
    {
        $response = $this-&gt;client-&gt;requestGrid(
            'tasks-grid',
            ['tasks-grid[_filter][reporterName][value]' =&gt; 'John Doe']
        );

        $result = $this-&gt;getJsonResponseContent($response, 200);
        $result = reset($result['data']);

        $this-&gt;client-&gt;request(
            'GET',
            $this-&gt;getUrl('orocrm_task_view', ['id' =&gt; $result['id']])
        );
        $result = $this-&gt;client-&gt;getResponse();

        $this-&gt;assertHtmlResponseStatusCodeEquals($result, 200);
        $this-&gt;assertContains('Task updated - Tasks - Activities', $result-&gt;getContent());
    }

    /**
     * @depends testUpdate
     */
    public function testIndex()
    {
        $this-&gt;client-&gt;request('GET', $this-&gt;getUrl('orocrm_task_index'));
        $result = $this-&gt;client-&gt;getResponse();
        $this-&gt;assertHtmlResponseStatusCodeEquals($result, 200);
        $this-&gt;assertContains('Task updated', $result-&gt;getContent());
    }
}
</code></pre>

<h3 id="tester-les-acls-dans-les-controlleurs">Tester les ACLs dans les controlleurs :</h3>
<p>Dans cet exemple, un utilisateur sans autorisations suffisantes essaie d’accéder à une action du contrôleur. La méthode assertHtmlResponseStatusCodeEquals()
est utilisée pour s’assurer que l’accès à la ressource demandée est refusé à l’utilisateur :</p>
<pre><code class="php">namespace Oro\Bundle\UserBundle\Tests\Functional;

use Oro\Bundle\UserBundle\Tests\Functional\DataFixtures\LoadUserData;
use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

/**
 * @outputBuffering enabled
 */
class UsersTest extends WebTestCase
{
    protected function setUp()
    {
        $this-&gt;initClient();
        $this-&gt;loadFixtures(['Oro\Bundle\UserBundle\Tests\Functional\API\DataFixtures\LoadUserData']);
    }

    public function testUsersIndex()
    {
        $this-&gt;client-&gt;request(
            'GET',
            $this-&gt;getUrl('oro_user_index'),
            [],
            [],
            $this-&gt;generateBasicAuthHeader(LoadUserData::USER_NAME, LoadUserData::USER_PASSWORD)
        );
        $result = $this-&gt;client-&gt;getResponse();
        $this-&gt;assertHtmlResponseStatusCodeEquals($result, 403);
    }

    public function testGetUsersAPI()
    {
        $this-&gt;client-&gt;request(
            'GET',
            $this-&gt;getUrl('oro_api_get_users'),
            ['limit' =&gt; 100],
            [],
            $this-&gt;generateWsseAuthHeader(LoadUserData::USER_NAME, LoadUserData::USER_API_KEY)
        );
        $result = $this-&gt;client-&gt;getResponse();
        $this-&gt;assertJsonResponseStatusCodeEquals($result, 403);
    }
}
</code></pre>

<p>Voici un exemple de fixture qui ajoute un utilisateur sans permission :</p>
<pre><code class="php">/ src/Oro/Bundle/UserBundle/Tests/Functional/DataFixtures/LoadUserData.php
namespace Oro\Bundle\UserBundle\Tests\Functional\DataFixtures;

use Doctrine\Common\DataFixtures\AbstractFixture;
use Doctrine\Common\Persistence\ObjectManager;

use Symfony\Component\DependencyInjection\ContainerAwareInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;

use Oro\Bundle\UserBundle\Entity\Role;
use Oro\Bundle\UserBundle\Entity\UserApi;

class LoadUserData extends AbstractFixture implements ContainerAwareInterface
{
    const USER_NAME     = 'user_wo_permissions';
    const USER_API_KEY  = 'user_api_key';
    const USER_PASSWORD = 'user_password';

    private $container;

    public function setContainer(ContainerInterface $container = null)
    {
        $this-&gt;container = $container;
    }

    public function load(ObjectManager $manager)
    {
        /** @var \Oro\Bundle\UserBundle\Entity\UserManager $userManager */
        $userManager = $this-&gt;container-&gt;get('oro_user.manager');

        // Find role for user to able to authenticate in test.
        // You can use any available role that you want dependently on test logic.
        $role = $manager-&gt;getRepository(Role::class)
            -&gt;findOneBy(['role' =&gt; 'IS_AUTHENTICATED_ANONYMOUSLY']);

        // Creating new user
        $user = $userManager-&gt;createUser();

        // Creating API entity for user, we will reference it in testGetUsersAPI method,
        // if you are not going to test API you can skip it
        $api = new UserApi();
        $api-&gt;setApiKey(self::USER_API_KEY)
            -&gt;setUser($user);

        // Creating user
        $user
            -&gt;setUsername(self::USER_NAME)
            -&gt;setPlainPassword(self::USER_PASSWORD) // This value is referenced in testUsersIndex method
            -&gt;setFirstName('Simple')
            -&gt;setLastName('User')
            -&gt;addRole($role)
            -&gt;setEmail('test@example.com')
            -&gt;setApi($api)
            -&gt;setSalt('');

        // Handle password encoding
        $userManager-&gt;updatePassword($user);

        $manager-&gt;persist($user);
        $manager-&gt;flush();
    }
}
</code></pre>

<h3 id="tester-les-commandes">Tester les commandes :</h3>
<p>Lorsque Oroplatform est installé, vous pouvez tester les commandes en utilisant la méthode runCommand()
de la classe WebTestCase. Cette méthode exécute une commande avec des paramètres donnés et retourne sa sortie
sous forme de chaîne. Par exemple, voyez à quoi ressemble le test pour la classe UpdateSchemaDoctrineListener du SearchBundle :</p>
<pre><code class="php">namespace Oro\Bundle\SearchBundle\Tests\Functional\EventListener;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class UpdateSchemaListenerTest extends WebTestCase
{
    protected function setUp()
    {
        $this-&gt;initClient();
    }

    /**
     * @dataProvider commandOptionsProvider
     */
    public function testCommand($commandName, array $params, $expectedContent)
    {
        $result = $this-&gt;runCommand($commandName, $params);
        $this-&gt;assertContains($expectedContent, $result);
    }

    public function commandOptionsProvider()
    {
        return [
            'otherCommand' =&gt; [
                'commandName'     =&gt; 'doctrine:mapping:info',
                'params'          =&gt; [],
                'expectedContent' =&gt; 'OK'
            ],
            'commandWithoutOption' =&gt; [
                'commandName'     =&gt; 'doctrine:schema:update',
                'params'          =&gt; [],
                'expectedContent' =&gt; 'Please run the operation by passing one - or both - of the following options:'
            ],
            'commandWithAnotherOption' =&gt; [
                'commandName'     =&gt; 'doctrine:schema:update',
                'params'          =&gt; ['--dump-sql' =&gt; true],
                'expectedContent' =&gt; 'ALTER TABLE'
            ],
            'commandWithForceOption' =&gt; [
                'commandName'     =&gt; 'doctrine:schema:update',
                'params'          =&gt; ['--force' =&gt; true],
                'expectedContent' =&gt; 'Schema update and create index completed'
            ]
        ];
    }
}
</code></pre>

<h3 id="voir-aussi">VOIR AUSSI</h3>
<p>Lisez les <a href="https://symfony.com/doc/master/components/console/introduction.html#testing-commands">Test des commandes</a>
dans la documentation officielle pour plus d’informations sur la façon de tester les commandes dans une application Symfony.</p>
<h3 id="tester-les-services-ou-les-repositories">Tester les services ou les Repositories</h3>
<p>Pour tester des services ou des dépôts, vous pouvez accéder au conteneur de service via la méthode getContainer() :</p>
<pre><code class="php">// src/Oro/Bundle/FooBarBundle/Tests/Functional/FooBarTest.php
namespace Oro\Bundle\FooBarBundle\Tests\Functional;

use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class FooBarTest extends WebTestCase
{
    protected $repositoryOrService;

    protected function setUp()
    {
        $this-&gt;initClient();
        $this-&gt;loadFixtures(['Oro\Bundle\FooBarBundle\Tests\Functional\API\DataFixtures\LoadFooBarData']);
        $this-&gt;repositoryOrService = $this-&gt;getContainer()-&gt;get('repository_or_service_id');
    }

    public function testMethod($commandName, array $params, $expectedContent)
    {
        $expected = 'test';
        $this-&gt;assertEquals($expected, $this-&gt;repositoryOrService-&gt;callTestMethod());
    }
</code></pre>

<h2 id="example-de-test-fonctionnel">Example de test fonctionnel :</h2>
<p>Ceci est un exemple de la façon dont vous pouvez écrire un test d’intégration pour une classe qui utilise l’ORM de doctrine
sans moquer ses classes et en utilisant de vrais services de Doctrine :</p>
<pre><code class="php">namespace Oro\Bundle\BatchBundle\Tests\Functional\ORM\QueryBuilder;

use Doctrine\ORM\Query\Expr\Join;
use Doctrine\ORM\QueryBuilder;
use Doctrine\ORM\EntityManager;
use Oro\Bundle\BatchBundle\ORM\QueryBuilder\CountQueryBuilderOptimizer;
use Oro\Bundle\TestFrameworkBundle\Test\WebTestCase;

class CountQueryBuilderOptimizerTest extends WebTestCase
{
    /**
     * @dataProvider getCountQueryBuilderDataProvider
     * @param QueryBuilder $queryBuilder
     * @param string $expectedDql
     */
    public function testGetCountQueryBuilder(QueryBuilder $queryBuilder, $expectedDql)
    {
        $optimizer = new CountQueryBuilderOptimizer();
        $countQb = $optimizer-&gt;getCountQueryBuilder($queryBuilder);
        $this-&gt;assertInstanceOf('Doctrine\ORM\QueryBuilder', $countQb);
        // Check for expected DQL
        $this-&gt;assertEquals($expectedDql, $countQb-&gt;getQuery()-&gt;getDQL());
        // Check that Optimized DQL can be converted to SQL
        $this-&gt;assertNotEmpty($countQb-&gt;getQuery()-&gt;getSQL());
    }

    /**
     * @return array
     */
    public function getCountQueryBuilderDataProvider()
    {
        self::initClient();
        $em = self::getContainer()-&gt;get('doctrine.orm.entity_manager');

        return [
            'simple' =&gt; [
                'queryBuilder' =&gt; self::createQueryBuilder($em)
                    -&gt;from('OroUserBundle:User', 'u')
                    -&gt;select(['u.id', 'u.username']),
                'expectedDQL' =&gt; 'SELECT u.id FROM OroUserBundle:User u'
            ],
            'group_test' =&gt; [
                'queryBuilder' =&gt; self::createQueryBuilder($em)
                    -&gt;from('OroUserBundle:User', 'u')
                    -&gt;select(['u.id', 'u.username as uName'])
                    -&gt;groupBy('uName'),
                'expectedDQL' =&gt; 'SELECT u.id, u.username as uName FROM OroUserBundle:User u GROUP BY uName'
            ]
        );
    }

    /**
     * @param EntityManager $entityManager
     * @return QueryBuilder
     */
    public static function createQueryBuilder(EntityManager $entityManager)
    {
        return new QueryBuilder($entityManager);
    }
}
</code></pre>

<h3 id="attention">Attention</h3>
<p>Si votre classe est responsable de la récupération des données, il est préférable de charger les fixtures et de les récupérer
en utilisant une classe de test, puis d’affirmer que les résultats sont valides. Vérifier le DQL suffit dans ce cas car c’est la seule responsabilité de cette classe de modifier la requête.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../javascript/" class="btn btn-neutral" title="Javascript"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../javascript/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
